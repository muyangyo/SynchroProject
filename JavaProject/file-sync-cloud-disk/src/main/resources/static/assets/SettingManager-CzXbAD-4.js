import{_ as ue,r as E,l as re,n as de,h as u,p as B,o as m,c as ce,a as n,w as t,e as c,b as P,t as g,u as O,d as v,q as y,E as ie,i as f,s as me}from"./index-iYnnpkLh.js";import{s as Y}from"./FileSizeConverter-DAwePfBB.js";import{r as x,J as ve}from"./RSAEncryptUtils-B9dLK6AK.js";import{u as ye}from"./index-B-2aGkoN.js";import{e as S,R as p}from"./RequestTool-BGG1PA9N.js";const fe={class:"dark-container"},Se={class:"main-container"},pe={class:"header"},Ce={class:"header-actions"},ge={class:"sync-name"},_e=2e3,Ne={__name:"SettingManager",setup(Pe){const{toClipboard:G}=ye(),o=E(""),w=E(""),M=E(!1),k=E([]),b=E(!1),T=E(!1),d=E(null),q={WAIT_CONNECT:"等待连接",CONNECTING:"连接中",SYNCING:"同步中",SYNC_COMPLETE:"同步完成",SYNC_FAILED:"同步失败",SYNC_STOP:"已暂停"};re(async()=>{await K(),await V()}),de(()=>{z()});const R=()=>{w.value=o.value==="server"?"client":"server",M.value=!0},K=()=>{S(p.GET,"/syncManager/getStatus",null,!1).then(l=>{l.statusCode==="SUCCESS"?o.value=l.data:u.error("获取用户模式失败")})},F=async()=>{try{S(p.POST,`/syncManager/changeStatus?changeTo=${w.value}`,null,!1,!1).then(l=>{l.statusCode==="SUCCESS"?(o.value=w.value,V(),M.value=!1,u.success(l.data?l.data:"模式切换成功")):u.error("模式切换失败")})}catch{u.error("模式切换失败")}},V=async()=>{S(p.GET,"/syncManager/getSyncInfoList",null,!1).then(l=>{l.statusCode==="SUCCESS"?(z(),k.value=[],k.value=l.data,ee()):u.error("加载同步列表失败")})},r=B({syncName:"",localPath:"",key:""}),j={syncName:[{required:!0,message:"请输入同步名称"},{pattern:/^[a-zA-Z0-9]{3,10}$/,message:"同步名称只能为英文或数字，长度限制为3-10个字符"}],localPath:[{required:!0,message:"请输入有效的绝对路径，支持中文路径",validator:(l,e,s)=>{/^(?:[a-zA-Z]:[\\/]|\\\\|[/])/.test(e)?s():s(new Error(l.message))}}],key:[{required:!0,message:"请输入同步链接"}]},J=()=>{if(o.value==="server"){let l={syncName:r.syncName,localPath:r.localPath};S(p.POST,"/syncManager/addSyncInfo",l,!0,!0).then(e=>{e.statusCode==="SUCCESS"?(u.success(e.data?e.data:"新增同步成功"),V()):u.error(e.errMsg?e.errMsg:"新增同步失败"),Object.keys(r).forEach(s=>r[s]="")})}else S(p.GET,"/syncManager/getPublicKey",null,!1).then(l=>{if(l.statusCode==="SUCCESS"&&l.data){x.setPublicKey(l.data);let e={key:x.encryptData(r.key),localPath:x.encryptData(r.localPath)};S(p.POST,"/syncManager/addSyncInfo",e,!0,!0).then(s=>{s.statusCode==="SUCCESS"?(u.success(s.data?s.data:"新增同步成功"),V()):u.error(s.errMsg?s.errMsg:"新增同步失败")})}else u.error("获取公钥失败");Object.keys(r).forEach(e=>r[e]="")});b.value=!1},i=B({localPath:"",serverIp:"",versionDelete:!1}),Z=l=>{d.value=l,i.localPath=l.localPath,o.value==="client"&&(i.serverIp=l.serverIp||""),o.value==="server"&&(i.versionDelete=l.versionDelete||!1),T.value=!0},W=()=>{if(d.value.localPath=i.localPath,o.value==="client"&&(d.value.serverIp=i.serverIp),o.value==="server"&&(d.value.versionDelete=i.versionDelete),T.value=!1,o.value==="server"){let l={syncName:d.value.syncName,localPath:d.value.localPath,versionDelete:d.value.versionDelete};S(p.POST,"/syncManager/updateSyncInfo",l,!0,!0).then(e=>{e.statusCode==="SUCCESS"?u.success(e.data?e.data:"同步设置已保存"):u.error(e.errMsg?e.errMsg:"同步设置保存失败"),V()})}else{let l={syncName:d.value.syncName,localPath:d.value.localPath,serverIp:d.value.serverIp};console.warn(l),S(p.POST,"/syncManager/updateSyncInfo",l,!0,!0).then(e=>{e.statusCode==="SUCCESS"?u.success(e.data?e.data:"同步设置已保存"):u.error(e.errMsg?e.errMsg:"同步设置保存失败"),V()})}},H=async l=>{const e=new ve({default_key_size:"2048"}),s=e.getPublicKeyB64();let _={syncName:l.syncName,key:s};S(p.POST,"/syncManager/getSyncShareLink",_,!0,!0).then(async h=>{if(h.statusCode==="SUCCESS"&&h.data){let D=e.decrypt(h.data);await G(D),u.success("链接已复制到剪贴板")}else u.error("获取分享链接失败")})},Q=async l=>{ie.confirm("确定删除该同步项？","警告",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}).then(()=>{S(p.DELETE,`/syncManager/deleteSyncInfo?syncName=${l.syncName}`,null,!0,!0).then(e=>{e.statusCode==="SUCCESS"?(u.success(e.data?e.data:"删除同步成功"),V()):u.error(e.errMsg?e.errMsg:"删除同步失败")})}).catch(()=>{})},X=async l=>{if(o.value!=="client")return;const e=l.status==="SYNC_STOP"?"SYNCING":"SYNC_STOP";(await S(p.POST,"/syncManager/updateSyncInfo",{newStatus:e,syncName:l.syncName},!0,!0)).statusCode==="SUCCESS"&&(l.status=e,u.success(`已${e==="SYNC_STOP"?"暂停":"恢复"}同步`),await L())};let U=null;const ee=()=>{o.value==="client"&&k.value.length>0&&(U=setInterval(L,_e))},z=()=>{U&&(clearInterval(U),U=null)},L=async()=>{if(!(o.value!=="client"||k.value.length===0))try{const l=k.value.map(s=>s.syncName),e=await S(p.GET,`/syncManager/getSyncStatusClientOnly?syncNames=${l.join(",")}`,null,!1);e.statusCode==="SUCCESS"&&le(e.data)}catch(l){console.error("状态更新失败",l)}},le=l=>{l.forEach(({syncName:e,syncStatus:s})=>{const _=k.value.find(h=>h.syncName===e);_&&(_.status=s)})},ae=l=>({SYNCING:"primary",SYNC_COMPLETE:"success",SYNC_FAILED:"danger",SYNC_STOP:"warning"})[l]||"info";return(l,e)=>{const s=f("el-button"),_=f("el-dialog"),h=f("el-icon"),D=f("el-tooltip"),I=f("el-table-column"),te=f("el-tag"),ne=f("el-table"),N=f("el-input"),C=f("el-form-item"),A=f("el-form"),se=f("el-switch"),oe=f("el-drawer");return m(),ce("div",fe,[n(_,{modelValue:M.value,"onUpdate:modelValue":e[1]||(e[1]=a=>M.value=a),title:`切换到${w.value==="server"?"服务端":"客户端"}模式`,width:"30%"},{footer:t(()=>[n(s,{onClick:e[0]||(e[0]=a=>M.value=!1)},{default:t(()=>e[15]||(e[15]=[c("取消")])),_:1}),n(s,{type:"danger",onClick:F},{default:t(()=>e[16]||(e[16]=[c("确认切换")])),_:1})]),default:t(()=>[e[17]||(e[17]=P("span",{style:{color:"white","font-weight":"bold"}},"⚠️警告: 切换模式将清空当前所有同步设置和操作日志，是否继续？",-1))]),_:1},8,["modelValue","title"]),P("div",Se,[P("div",pe,[P("h2",null,"同步管理 - "+g(o.value==="server"?"服务端":"客户端"),1),P("div",Ce,[n(s,{type:"info",onClick:R},{default:t(()=>[c(" 切换模式 (当前: "+g(o.value==="server"?"服务端":"客户端")+") ",1)]),_:1}),n(s,{type:"primary",onClick:e[2]||(e[2]=a=>b.value=!0)},{default:t(()=>[c(g(o.value==="server"?"新增同步":"添加同步"),1)]),_:1})])]),n(ne,{data:k.value,class:"dark-table"},{default:t(()=>[n(I,{label:"同步名","min-width":"100"},{default:t(({row:a})=>[n(D,{content:`最近同步时间: ${a.lastSyncTime}`,placement:"right"},{default:t(()=>[P("div",ge,[n(h,null,{default:t(()=>[n(O(me))]),_:1}),P("span",null,g(a.syncName),1)])]),_:2},1032,["content"])]),_:1}),o.value==="server"?(m(),v(I,{key:0,label:"本地大小","max-width":"100",align:"center"},{default:t(({row:a})=>[c(g(O(Y)(a.localSize)),1)]),_:1})):y("",!0),o.value==="client"?(m(),v(I,{key:1,label:"状态","max-width":"200",align:"center"},{default:t(({row:a})=>[n(te,{type:ae(a.status)},{default:t(()=>[c(g(q[a.status]||a.status),1)]),_:2},1032,["type"])]),_:1})):y("",!0),o.value==="client"?(m(),v(I,{key:2,label:"本地大小","max-width":"200",align:"center"},{default:t(({row:a})=>[c(g(O(Y)(a.localSize)),1)]),_:1})):y("",!0),n(I,{label:"操作","min-width":"80"},{default:t(({row:a})=>[n(s,{size:"small",onClick:$=>Z(a)},{default:t(()=>e[18]||(e[18]=[c("设置")])),_:2},1032,["onClick"]),o.value==="client"?(m(),v(s,{key:0,size:"small",type:"warning",onClick:$=>X(a)},{default:t(()=>[c(g(a.status==="SYNC_STOP"?"恢复":"暂停"),1)]),_:2},1032,["onClick"])):y("",!0),o.value==="server"?(m(),v(s,{key:1,size:"small",type:"success",onClick:$=>H(a)},{default:t(()=>e[19]||(e[19]=[c(" 分享 ")])),_:2},1032,["onClick"])):y("",!0),n(s,{size:"small",type:"danger",onClick:$=>Q(a)},{default:t(()=>e[20]||(e[20]=[c(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),n(_,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=a=>b.value=a),title:o.value==="server"?"新建同步":"添加同步链接",draggable:!0},{footer:t(()=>[n(s,{onClick:e[7]||(e[7]=a=>b.value=!1)},{default:t(()=>e[21]||(e[21]=[c("取消")])),_:1}),n(s,{type:"primary",onClick:J},{default:t(()=>e[22]||(e[22]=[c("确认")])),_:1})]),default:t(()=>[n(A,{model:r,"label-width":"120px",rules:j},{default:t(()=>[o.value==="server"?(m(),v(C,{key:0,label:"同步名称",prop:"syncName"},{default:t(()=>[n(N,{modelValue:r.syncName,"onUpdate:modelValue":e[3]||(e[3]=a=>r.syncName=a),placeholder:"目前只支持英文、数字构成的同步名称"},null,8,["modelValue"])]),_:1})):y("",!0),o.value==="server"?(m(),v(C,{key:1,label:"本地路径",prop:"localPath"},{default:t(()=>[n(N,{modelValue:r.localPath,"onUpdate:modelValue":e[4]||(e[4]=a=>r.localPath=a),placeholder:"绝对路径，如：C:/sync_folder"},null,8,["modelValue"])]),_:1})):y("",!0),o.value==="client"?(m(),v(C,{key:2,label:"同步Key",prop:"key"},{default:t(()=>[n(N,{modelValue:r.key,"onUpdate:modelValue":e[5]||(e[5]=a=>r.key=a),placeholder:"输入服务端提供的分享链接"},null,8,["modelValue"])]),_:1})):y("",!0),o.value==="client"?(m(),v(C,{key:3,label:"本地路径",prop:"localPath"},{default:t(()=>[n(N,{modelValue:r.localPath,"onUpdate:modelValue":e[6]||(e[6]=a=>r.localPath=a),placeholder:"绝对路径，如：C:/sync_folder"},null,8,["modelValue"])]),_:1})):y("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),n(oe,{modelValue:T.value,"onUpdate:modelValue":e[14]||(e[14]=a=>T.value=a),direction:"rtl",size:"40%"},{header:t(()=>{var a;return[P("h3",null,g((a=d.value)==null?void 0:a.syncName)+" - 设置",1)]}),footer:t(()=>[n(s,{onClick:e[13]||(e[13]=a=>T.value=!1)},{default:t(()=>e[23]||(e[23]=[c("取消")])),_:1}),n(s,{type:"primary",onClick:W},{default:t(()=>e[24]||(e[24]=[c("保存")])),_:1})]),default:t(()=>[d.value?(m(),v(A,{key:0,model:i},{default:t(()=>[n(C,{label:"同步名称"},{default:t(()=>[n(N,{modelValue:d.value.syncName,"onUpdate:modelValue":e[9]||(e[9]=a=>d.value.syncName=a),disabled:""},null,8,["modelValue"])]),_:1}),n(C,{label:"本地路径"},{default:t(()=>[n(N,{modelValue:i.localPath,"onUpdate:modelValue":e[10]||(e[10]=a=>i.localPath=a)},null,8,["modelValue"])]),_:1}),o.value==="client"?(m(),v(C,{key:0,label:"服务器 IP"},{default:t(()=>[n(N,{modelValue:i.serverIp,"onUpdate:modelValue":e[11]||(e[11]=a=>i.serverIp=a),placeholder:"请输入服务器 IP 地址"},null,8,["modelValue"])]),_:1})):y("",!0),o.value==="server"?(m(),v(C,{key:1,label:"版本删除"},{default:t(()=>[n(se,{modelValue:i.versionDelete,"onUpdate:modelValue":e[12]||(e[12]=a=>i.versionDelete=a),disabled:""},null,8,["modelValue"])]),_:1})):y("",!0),n(C,{label:"本地大小"},{default:t(()=>[n(N,{value:O(Y)(d.value.localSize),disabled:""},null,8,["value"])]),_:1})]),_:1},8,["model"])):y("",!0)]),_:1},8,["modelValue"])])])}}},be=ue(Ne,[["__scopeId","data-v-a584a334"]]);export{be as default};
