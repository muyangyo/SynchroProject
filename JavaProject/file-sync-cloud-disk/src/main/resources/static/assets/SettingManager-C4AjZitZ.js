import{_ as ue,r as b,l as de,n as ie,h as r,p as B,o as m,c as ce,a as n,w as a,e as d,b as g,t as _,u as E,d as v,q as f,E as me,i as y,s as ve}from"./index-BdDz8YT7.js";import{s as L}from"./FileSizeConverter-DAwePfBB.js";import{r as x,J as fe}from"./RSAEncryptUtils-B9dLK6AK.js";import{u as ye}from"./index-Ci8lICnv.js";import{e as S,R as p}from"./RequestTool-CqJjP4cz.js";const Se=""+new URL("server-CIude_pz.gif",import.meta.url).href,pe=""+new URL("client-Ba2BGox7.gif",import.meta.url).href,Ce={class:"dark-container"},ge={class:"main-container"},_e={class:"header"},Ne=["src"],ke={class:"header-actions"},Pe={class:"sync-name"},he=2e3,Ve={__name:"SettingManager",setup(be){const{toClipboard:A}=ye(),R=()=>{window.open("https://icons8.com/","_blank")},o=b(""),U=b(""),M=b(!1),P=b([]),T=b(!1),I=b(!1),i=b(null),q={WAIT_CONNECT:"等待连接",CONNECTING:"连接中",SYNCING:"同步中",SYNC_COMPLETE:"同步完成",SYNC_FAILED:"同步失败",SYNC_STOP:"已暂停"};de(async()=>{await F(),await h()}),ie(()=>{z()});const K=()=>{U.value=o.value==="server"?"client":"server",M.value=!0},F=()=>{S(p.GET,"/syncManager/getStatus",null,!1).then(l=>{l.statusCode==="SUCCESS"?o.value=l.data:r.error("获取用户模式失败")})},j=async()=>{try{S(p.POST,`/syncManager/changeStatus?changeTo=${U.value}`,null,!1,!1).then(l=>{l.statusCode==="SUCCESS"?(o.value=U.value,h(),M.value=!1,r.success(l.data?l.data:"模式切换成功")):r.error("模式切换失败")})}catch{r.error("模式切换失败")}},h=async()=>{S(p.GET,"/syncManager/getSyncInfoList",null,!1).then(l=>{l.statusCode==="SUCCESS"?(z(),P.value=[],P.value=l.data,le()):r.error("加载同步列表失败")})},u=B({syncName:"",localPath:"",key:""}),J={syncName:[{required:!0,message:"请输入同步名称"},{pattern:/^[a-zA-Z0-9]{3,10}$/,message:"同步名称只能为英文或数字，长度限制为3-10个字符"}],localPath:[{required:!0,message:"请输入有效的绝对路径，支持中文路径",validator:(l,e,s)=>{/^(?:[a-zA-Z]:[\\/]|\\\\|[/])/.test(e)?s():s(new Error(l.message))}}],key:[{required:!0,message:"请输入同步链接"}]},Z=()=>{if(o.value==="server"){let l={syncName:u.syncName,localPath:u.localPath};S(p.POST,"/syncManager/addSyncInfo",l,!0,!0).then(e=>{e.statusCode==="SUCCESS"?(r.success(e.data?e.data:"新增同步成功"),h()):r.error(e.errMsg?e.errMsg:"新增同步失败"),Object.keys(u).forEach(s=>u[s]="")})}else S(p.GET,"/syncManager/getPublicKey",null,!1).then(l=>{if(l.statusCode==="SUCCESS"&&l.data){x.setPublicKey(l.data);let e={key:x.encryptData(u.key),localPath:x.encryptData(u.localPath)};S(p.POST,"/syncManager/addSyncInfo",e,!0,!0).then(s=>{s.statusCode==="SUCCESS"?(r.success(s.data?s.data:"新增同步成功"),h()):r.error(s.errMsg?s.errMsg:"新增同步失败")})}else r.error("获取公钥失败");Object.keys(u).forEach(e=>u[e]="")});T.value=!1},c=B({localPath:"",serverIp:"",versionDelete:!1}),W=l=>{i.value=l,c.localPath=l.localPath,o.value==="client"&&(c.serverIp=l.serverIp||""),o.value==="server"&&(c.versionDelete=l.versionDelete||!1),I.value=!0},H=()=>{if(i.value.localPath=c.localPath,o.value==="client"&&(i.value.serverIp=c.serverIp),o.value==="server"&&(i.value.versionDelete=c.versionDelete),I.value=!1,o.value==="server"){let l={syncName:i.value.syncName,localPath:i.value.localPath,versionDelete:i.value.versionDelete};S(p.POST,"/syncManager/updateSyncInfo",l,!0,!0).then(e=>{e.statusCode==="SUCCESS"?r.success(e.data?e.data:"同步设置已保存"):r.error(e.errMsg?e.errMsg:"同步设置保存失败"),h()})}else{let l={syncName:i.value.syncName,localPath:i.value.localPath,serverIp:i.value.serverIp};console.warn(l),S(p.POST,"/syncManager/updateSyncInfo",l,!0,!0).then(e=>{e.statusCode==="SUCCESS"?r.success(e.data?e.data:"同步设置已保存"):r.error(e.errMsg?e.errMsg:"同步设置保存失败"),h()})}},Q=async l=>{const e=new fe({default_key_size:"2048"}),s=e.getPublicKeyB64();let N={syncName:l.syncName,key:s};S(p.POST,"/syncManager/getSyncShareLink",N,!0,!0).then(async V=>{if(V.statusCode==="SUCCESS"&&V.data){let D=e.decrypt(V.data);await A(D),r.success("链接已复制到剪贴板")}else r.error("获取分享链接失败")})},X=async l=>{me.confirm("确定删除该同步项？","警告",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}).then(()=>{S(p.DELETE,`/syncManager/deleteSyncInfo?syncName=${l.syncName}`,null,!0,!0).then(e=>{e.statusCode==="SUCCESS"?(r.success(e.data?e.data:"删除同步成功"),h()):r.error(e.errMsg?e.errMsg:"删除同步失败")})}).catch(()=>{})},ee=async l=>{if(o.value!=="client")return;const e=l.status==="SYNC_STOP"?"SYNCING":"SYNC_STOP";(await S(p.POST,"/syncManager/updateSyncInfo",{newStatus:e,syncName:l.syncName},!0,!0)).statusCode==="SUCCESS"&&(l.status=e,r.success(`已${e==="SYNC_STOP"?"暂停":"恢复"}同步`),await Y())};let O=null;const le=()=>{o.value==="client"&&P.value.length>0&&(O=setInterval(Y,he))},z=()=>{O&&(clearInterval(O),O=null)},Y=async()=>{if(!(o.value!=="client"||P.value.length===0))try{const l=P.value.map(s=>s.syncName),e=await S(p.GET,`/syncManager/getSyncStatusClientOnly?syncNames=${l.join(",")}`,null,!1);e.statusCode==="SUCCESS"&&te(e.data)}catch(l){console.error("状态更新失败",l)}},te=l=>{l.forEach(({syncName:e,syncStatus:s})=>{const N=P.value.find(V=>V.syncName===e);N&&(N.status=s)})},ae=l=>({SYNCING:"primary",SYNC_COMPLETE:"success",SYNC_FAILED:"danger",SYNC_STOP:"warning"})[l]||"info";return(l,e)=>{const s=y("el-button"),N=y("el-dialog"),V=y("el-icon"),D=y("el-tooltip"),w=y("el-table-column"),ne=y("el-tag"),se=y("el-table"),k=y("el-input"),C=y("el-form-item"),G=y("el-form"),oe=y("el-switch"),re=y("el-drawer");return m(),ce("div",Ce,[n(N,{modelValue:M.value,"onUpdate:modelValue":e[1]||(e[1]=t=>M.value=t),title:`切换到${U.value==="server"?"服务端":"客户端"}模式`,width:"30%"},{footer:a(()=>[n(s,{onClick:e[0]||(e[0]=t=>M.value=!1)},{default:a(()=>e[15]||(e[15]=[d("取消")])),_:1}),n(s,{type:"danger",onClick:j},{default:a(()=>e[16]||(e[16]=[d("确认切换")])),_:1})]),default:a(()=>[e[17]||(e[17]=g("span",{style:{color:"white","font-weight":"bold"}},"⚠️警告: 切换模式将清空当前所有同步设置和操作日志，是否继续？",-1))]),_:1},8,["modelValue","title"]),g("div",ge,[g("div",_e,[g("h2",null,[d("同步管理 - "+_(o.value==="server"?"服务端":"客户端")+" ",1),g("img",{src:o.value==="server"?E(Se):E(pe),class:"mode-gif",onClick:R},null,8,Ne)]),g("div",ke,[n(s,{type:"info",onClick:K},{default:a(()=>[d(" 切换模式 (当前: "+_(o.value==="server"?"服务端":"客户端")+") ",1)]),_:1}),n(s,{type:"primary",onClick:e[2]||(e[2]=t=>T.value=!0)},{default:a(()=>[d(_(o.value==="server"?"新增同步":"添加同步"),1)]),_:1})])]),n(se,{data:P.value,class:"dark-table"},{default:a(()=>[n(w,{label:"同步名","min-width":"100"},{default:a(({row:t})=>[n(D,{content:`最近同步时间: ${t.lastSyncTime}`,placement:"right"},{default:a(()=>[g("div",Pe,[n(V,null,{default:a(()=>[n(E(ve))]),_:1}),g("span",null,_(t.syncName),1)])]),_:2},1032,["content"])]),_:1}),o.value==="server"?(m(),v(w,{key:0,label:"本地大小","max-width":"100",align:"center"},{default:a(({row:t})=>[d(_(E(L)(t.localSize)),1)]),_:1})):f("",!0),o.value==="client"?(m(),v(w,{key:1,label:"状态","max-width":"200",align:"center"},{default:a(({row:t})=>[n(ne,{type:ae(t.status)},{default:a(()=>[d(_(q[t.status]||t.status),1)]),_:2},1032,["type"])]),_:1})):f("",!0),o.value==="client"?(m(),v(w,{key:2,label:"本地大小","max-width":"200",align:"center"},{default:a(({row:t})=>[d(_(E(L)(t.localSize)),1)]),_:1})):f("",!0),n(w,{label:"操作","min-width":"80"},{default:a(({row:t})=>[n(s,{size:"small",onClick:$=>W(t)},{default:a(()=>e[18]||(e[18]=[d("设置")])),_:2},1032,["onClick"]),o.value==="client"?(m(),v(s,{key:0,size:"small",type:"warning",onClick:$=>ee(t)},{default:a(()=>[d(_(t.status==="SYNC_STOP"?"恢复":"暂停"),1)]),_:2},1032,["onClick"])):f("",!0),o.value==="server"?(m(),v(s,{key:1,size:"small",type:"success",onClick:$=>Q(t)},{default:a(()=>e[19]||(e[19]=[d(" 分享 ")])),_:2},1032,["onClick"])):f("",!0),n(s,{size:"small",type:"danger",onClick:$=>X(t)},{default:a(()=>e[20]||(e[20]=[d(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),n(N,{modelValue:T.value,"onUpdate:modelValue":e[8]||(e[8]=t=>T.value=t),title:o.value==="server"?"新建同步":"添加同步链接",draggable:!0},{footer:a(()=>[n(s,{onClick:e[7]||(e[7]=t=>T.value=!1)},{default:a(()=>e[21]||(e[21]=[d("取消")])),_:1}),n(s,{type:"primary",onClick:Z},{default:a(()=>e[22]||(e[22]=[d("确认")])),_:1})]),default:a(()=>[n(G,{model:u,"label-width":"120px",rules:J},{default:a(()=>[o.value==="server"?(m(),v(C,{key:0,label:"同步名称",prop:"syncName"},{default:a(()=>[n(k,{modelValue:u.syncName,"onUpdate:modelValue":e[3]||(e[3]=t=>u.syncName=t),placeholder:"目前只支持英文、数字构成的同步名称"},null,8,["modelValue"])]),_:1})):f("",!0),o.value==="server"?(m(),v(C,{key:1,label:"本地路径",prop:"localPath"},{default:a(()=>[n(k,{modelValue:u.localPath,"onUpdate:modelValue":e[4]||(e[4]=t=>u.localPath=t),placeholder:"绝对路径，如：C:/sync_folder"},null,8,["modelValue"])]),_:1})):f("",!0),o.value==="client"?(m(),v(C,{key:2,label:"同步Key",prop:"key"},{default:a(()=>[n(k,{modelValue:u.key,"onUpdate:modelValue":e[5]||(e[5]=t=>u.key=t),placeholder:"输入服务端提供的分享链接"},null,8,["modelValue"])]),_:1})):f("",!0),o.value==="client"?(m(),v(C,{key:3,label:"本地路径",prop:"localPath"},{default:a(()=>[n(k,{modelValue:u.localPath,"onUpdate:modelValue":e[6]||(e[6]=t=>u.localPath=t),placeholder:"绝对路径，如：C:/sync_folder"},null,8,["modelValue"])]),_:1})):f("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),n(re,{modelValue:I.value,"onUpdate:modelValue":e[14]||(e[14]=t=>I.value=t),direction:"rtl",size:"40%"},{header:a(()=>{var t;return[g("h3",null,_((t=i.value)==null?void 0:t.syncName)+" - 设置",1)]}),footer:a(()=>[n(s,{onClick:e[13]||(e[13]=t=>I.value=!1)},{default:a(()=>e[23]||(e[23]=[d("取消")])),_:1}),n(s,{type:"primary",onClick:H},{default:a(()=>e[24]||(e[24]=[d("保存")])),_:1})]),default:a(()=>[i.value?(m(),v(G,{key:0,model:c},{default:a(()=>[n(C,{label:"同步名称"},{default:a(()=>[n(k,{modelValue:i.value.syncName,"onUpdate:modelValue":e[9]||(e[9]=t=>i.value.syncName=t),disabled:""},null,8,["modelValue"])]),_:1}),n(C,{label:"本地路径"},{default:a(()=>[n(k,{modelValue:c.localPath,"onUpdate:modelValue":e[10]||(e[10]=t=>c.localPath=t)},null,8,["modelValue"])]),_:1}),o.value==="client"?(m(),v(C,{key:0,label:"服务器 IP"},{default:a(()=>[n(k,{modelValue:c.serverIp,"onUpdate:modelValue":e[11]||(e[11]=t=>c.serverIp=t),placeholder:"请输入服务器 IP 地址"},null,8,["modelValue"])]),_:1})):f("",!0),o.value==="server"?(m(),v(C,{key:1,label:"版本删除"},{default:a(()=>[n(oe,{modelValue:c.versionDelete,"onUpdate:modelValue":e[12]||(e[12]=t=>c.versionDelete=t),disabled:""},null,8,["modelValue"])]),_:1})):f("",!0),n(C,{label:"本地大小"},{default:a(()=>[n(k,{value:E(L)(i.value.localSize),disabled:""},null,8,["value"])]),_:1})]),_:1},8,["model"])):f("",!0)]),_:1},8,["modelValue"])])])}}},Ue=ue(Ve,[["__scopeId","data-v-4c725b2f"]]);export{Ue as default};
